shared_configs:
  simple_job_steps: &simple_job_steps
    - checkout
    #TODO: caching config so we don't accidentally try to re-use
    #cache across versions of Go...

    #- restore_cache:
    #    keys:
    #      - go-mod-v4-{{ checksum "go.sum" }}
    #- run:
    #    name: Install Dependencies
    #    command: go mod download
    #- save_cache:
    #    key: go-mod-v4-{{ checksum "go.sum" }}
    #    paths:
    #      - "/go/pkg/mod"
    - run:
        name: Run tests
        command: |
          #mkdir -p /tmp/test-reports
          #gotestsum --junitfile /tmp/test-reports/unit-tests.xml
          make deps test
    #- store_test_results:
    #    path: /tmp/test-reports


# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
jobs:
  build-1-12-gopath:
    working_directory: ~/gopath/github.com/jhump/protoreflect
    docker:
      - image: circleci/golang:1.12
    environment:
      GO111MODULE: "off"
      GOPATH: ~/gopath
    steps: *simple_job_steps

  build-1-12:
    working_directory: ~/repo
    docker:
      - image: circleci/golang:1.12
    environment:
      GO111MODULE: "on"
    steps: *simple_job_steps

  build-1-13:
    working_directory: ~/repo
    docker:
      - image: circleci/golang:1.12
    environment:
      GO111MODULE: "on"
    steps:
    - checkout
    - restore_cache:
        keys:
          - go-mod-v4-{{ checksum "go.sum" }}
    - run:
        name: Install Dependencies
        command: go mod download
    - save_cache:
        key: go-mod-v4-{{ checksum "go.sum" }}
        paths:
          - "/go/pkg/mod"
    - run:
        name: Run tests
        command: |
          #mkdir -p /tmp/test-reports
          #gotestsum --junitfile /tmp/test-reports/unit-tests.xml
          make ci
    #- store_test_results:
    #    path: /tmp/test-reports

  build-1-14:
    working_directory: ~/repo
    docker:
      - image: circleci/golang:1.14
    steps: *simple_job_steps

  build-1-15:
    working_directory: ~/repo
    docker:
      - image: circleci/golang:1.15
    steps: *simple_job_steps

  build-1-16:
    working_directory: ~/repo
    docker:
      - image: circleci/golang:1.16
    steps: *simple_job_steps

workflows:
  pr-build-test:
    jobs:
      - build-1-12-gopath
#      - build-1-12
#      - build-1-13
#      - build-1-14
#      - build-1-15
#      - build-1-16
